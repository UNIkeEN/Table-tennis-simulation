# SJTU CS1501 大作业

UNIkeEN 2021 Fall

简单的模拟算法，但是设计了一些菜单和简单UI

## 1.  绪论

乒乓球是一种世界流行的体育项目，也是中国的“国球”。2001年9月1日起，国际乒联推行乒乓球赛制改革，将每局比分由21分改为11分。时任国际乒联主席沙拉拉声称此项改革的目的是加快比赛节奏、便于电视转播。赛制的改革势必会对参赛选手与比赛结果造成影响。有观点认为，对自从1988年起即垄断奥运会金牌的中国队，赛制改变的影响将尤其大。为此，可以构建C++程序，由用户输入比赛与选手的相关参数或使用预置参数，重复模拟比赛进程，在统计学上计算胜率并计算赛制变化前后的胜率变化。

## 2.模型构建

### 2.1 选手参数量化

   为模拟比赛进程，需要对双方选手的能力进行量化。与广泛采用的三段统计法不同，本程序采用的模型借鉴并简化了李丕亮等人提出的10项指标评估法[1]，对运动员前四板技术结合进攻、相持、防御3方面设立评估指标。分别是：

（1）发球直接得分率：指在第一板发球直接得分的概率；

（2） 进攻时命中率：指进行发球抢攻、接球抢攻或发球反攻时球不出界的概率；

（3）非进攻时命中率：除上述情况外球不出界的概率；

（4）受进攻时接球成功率：收到对方发球抢攻、接球抢攻或发球反攻且球未出界时接到球的概率；

（5）非受进攻时接球成功率：除上述情况外，球未出界时接到球的概率；

（6） 接球抢攻使用率：接到对手第一板发球后，决定使用接球抢攻战术的概率；

（7）发球反攻使用率：接到对手接球抢攻后，决定使用发球反攻战术的概率；

（8）发球抢攻使用率：接到对手接发球后，决定使用发球抢攻战术的概率；

（9）相持状态能力：一个0-100范围的整数，表示进入相持状态后相对能力 

以上状态是选手的基础能力数值，为更好模拟比赛的随机性与紧张氛围，以上各命中率与接球成功率的具体值会有所变化，具体实现方法见第4节。

### 2.2 比赛过程模拟

将两位选手命名为击球方和接球方，击球动作包括发球、接发球、接球抢攻、发球抢攻和发球反攻等。

当一局比赛开始时，先随机一位选手作为击球方进行第一板发球。发球可能直接得分，若未直接得分则计算是否命中（即是否未出界），若命中，转移到接球方计算是否接住。若接球方成功接住，则判断采取策略，然后接球方变成新的击球方，计算是否命中……击球方和接球方循环往复，直至一方得分，计算比分，若一局比赛未结束则判断是否更换发球方并进入下一次发球。

由于乒乓球战术主要围绕每个球的前三板展开，所以，程序将模拟前三板球的具体过程，当球在场上来回至第四板及以上时，该球将被判断为“进入相持状态”，通过比较双方选手的相持能力判定该球的胜负。

   为简化程序设计，默认比赛中不出现犯规的情况。

## 3.程序架构设计

程序中包含了两个自定义库：`cmd_opts` (Console_Operations)库和 `ppong` (PingPong) 库，它们的头文件和实现文件分开放置于/lib和/src子目录下，达到接口与实现过程分开的目的。

`cmd_opts` 库中包含了简单用户交互界面所需要的一些函数。

`ppong` 库中包含了储存选手、赛制等参数的类和模拟比赛进程的相关函数。

`main.cpp` 中包含了与用户交互的大部分代码如功能菜单选择、参数输入和展示。各库中的详细设计和关键函数、类及数据成员将在下节叙述。

## 4.功能详细设计

### 4.1 用户交互界面

#### 4.1.1 `cmd_opts` 库的关键函数

`cmd_opts` 库基于 `windows.h` 和 `conio.h` 库，包含了关于用户界面交互的一些函数，如Console窗口的参数设置、输入事件等。

为简化，将标准输入输出设备的句柄简化为全局常量。

```c++
static const HANDLE __hout = GetStdHandle(STD_OUTPUT_HANDLE); 
static const HANDLE __hin  = GetStdHandle(STD_INPUT_HANDLE); 
```

**`cmd_opts` 库的全部函数如下（关于函数用途的注释已省略）：**

```c++
void copts_setconsoletitle(const char *title);
void copts_fixconsolesize(void);
void copts_cls(void);
void copts_gotoxy(const int X, const int Y);
void copts_printxy(const int &X,const int &Y,std::string str);
void copts_printspace(const int &X,const int &Y,const int &rpt);
void copts_printline(const int &X,const int &Y,const int &rpt);
void copts_setconsoleborder(int set_cols, int set_lines, int set_buffer_cols, int set_buffer_lines);
void copts_showcursor();
void copts_hidecursor();
```

**以下是部分关键函数的功能说明、参数说明、代码及运行结果：**

**（1）`copts_cls` 清屏函数**

功能：清除屏幕所有内容，用于页面的初始化和切换

**（2）`copts_gotoxy` 函数**

功能：将光标移动到指定位置，以屏幕左上角坐标为(0,0)

参数：const int X：X轴坐标（列）；const int Y：Y轴坐标（行）

**（3）`copts_printxy` 输出字符串函数**

功能：在指定位置输出一个字符串，以屏幕左上角坐标为(0,0)

参数：const int X：X轴坐标（列）；const int Y：Y轴坐标（行）；string str：要输出的字符串

#### 4.1.2 `main` 函数中用户界面的关键函数

   本程序含有主菜单、参数选择、选手能力展示页、比赛演示等多个页面，采用一系列的函数来切换页面。同时，在允许来回切换的页面，多使用while(1)语句，使二级界面的函数返回后重新加载一级界面。这样的方法相较于递归，可以防止多次页面切换后递归层数过多的问题。

main函数中关于用户界面的全部函数如下：

```c++
void InitializeWindow(); //窗口初始化
void Page_MainMenu(); //主菜单页
void Page_Custom_Paraset(); //自定义计算参数设置
void Page_Custom_Paraset_RMenu(const int index); //自定义计算参数界面右侧菜单（此函数只负责显示）
void Page_Custom_Paraset_Input(PlayerLevel &y,int id); //自定义选手参数输入界面
bool Page_CustomII();
void Page_Demo(); //演示计算页面I
void Page_DemoII(); //演示计算页面II
void ShowPlrPara(int i); //显示选手参数（子函数）
void Page_Result(); //显示结果
```

**以下是部分关键函数的功能说明、代码及运行结果：**

**（1）主菜单 `Page_MainMenu` 函数**

功能：程序开始时显示的主菜单页面。

   运行后，程序使用getch函数监听键盘按下按钮的ASCII码并判断，直到用户按下数字1、2或ESC键。按1执行Page_Custom_Paraset函数并进入自定义参数界面；按2执行Page_Demo函数并进入演示界面；按ESC键使用exit（0）命令退出程序。

**（2）自定义参数界面 `Page_Custom_Paraset` 函数与 `Page_Custom_Paraset_Rmenu` 函数**

功能：显示自定义参数界面，用户在此界面输入选手参数、选择赛制。

本函数中利用标签和 `goto` 语句，当下一个页面返回后可以重新加载本页面。

用户按上下方向键选择左侧的一级菜单，按方框中的数字键选择右侧的二级菜单；ESC键退出程序；退格键返回上一级（主菜单）；N键进入下一步。

**（3）选手能力表 `Page_CustomII` 函数、 `Page_Demo` 函数与 `ShowPlrPara` 函数**

功能：显示选手能力参数

自定义参数模式下执行 `Page_CustomII` 函数，演示模式下执行 `Page_Demo` 函数。二者不同之处在于，演示模式运行 `Page_Demo` 后将首先随机两位选手的各项参数。`ShowPlrPara` 为前两者的子函数。

**（4）结果展示页 `Page_Result` 函数**

功能：显示多场比赛的模拟结果（此时不显示比赛具体过程），演示模式下额外输出11分制和21分制的结果比较。

### 4.2 比赛模拟（`ppong` 库内容介绍）

#### 4.2.1 `PlayerLevel` 结构体

本程序使用结构体存储选手能力参数，便于数据管理。各数据含义请见2.1节。

```c++
struct PlayerLevel{
  float first_sev_scr; //发球直接得分率
  float atk_hit; //进攻时命中率（未命中则对手加分，命中则进行对方接球判定）
  float nor_hit; //非进攻时命中率
  float atk_catch; //受进攻时接球成功率
  float nor_catch; //受非进攻时接球成功率
  float sevatk_usg; //发球抢攻使用率（己方第二板）
  float sevctratk_usg; //发球反攻使用率（己方第二板）
  float cthatk_usg; //接球抢攻使用率（对方第一板）
  int stalemate_lv; //相持状态能力（按两方能力计算相持状态胜率）
  int syn_lv; //综合总能力
  float addi_hit=1; //心理状态和随机情况对命中率的加成倍率
float addi_cth=1; //心理状态和随机情况对接球成功率的加成倍率
};
```

#### 4.2.2 `Game` 类的数据成员与关键函数

本程序创建了一个类 `Game`，存放一场比赛的赛制数据、选手数据和比分数据与模拟比赛相关的成员函数。

赛制数据与选手数据作为用户可自定义的选项，为了简化赋值设为公有成员（可以利用友元函数改进）；比分数据作为私有成员，可避免类外函数的修改。

模拟比赛的函数除 `Simulation` 函数外均为私有函数，类的使用者将无法直接访问包括击球函数、接球函数在内的具体模拟过程，后述函数都是Simulation的子过程。

**Game类中各函数调用的关系图（即执行 `Simulation` 函数后的流程）如下：**

**以下是部分关键函数的功能说明、代码及运行结果：**

**（1）`Random` 随机函数**

功能：根据 `prob` 参数作为真的概率，使用 `rand` 函数随机并返回真假。（对应 `srand` 在 `main` 函数中执行）

**（2）`Simulation` 模拟比赛主函数**

功能：模拟一场比赛过程的主函数。包括：判断发球方->第一板发球->交换发球方->判断比赛结束。类的使用者只能调用此函数以开始比赛模拟。

返回值：int，为胜利选手的编号。

**（3）`Checkover` 函数**

功能：根据比分判断一局比赛是否结束

返回值：bool，真/假分别表示是/否结束

**（4）`MoodandRand` 函数**

功能：为更好模拟比赛的随机性与紧张氛围，以上各命中率与接球成功率的具体值会有所变化。

每次发球前都将产生介于0.95-1.1的数值1。当二者比分差大于等于3时触发条件，领先者有很小概率“有所放松” (下一球接球率、命中率略微下降)，落后者有较小概率“坚持不懈,奋起直追” (下一球命中率略微提升)，心理影响量化为数值2。对命中率和接球成功率分别计算各自的**数值1\*数值2，作为额外倍率**。额外倍率将和选手开始比赛前输入的基础倍率共同作用。

**（5）`Hit` 击球函数**

功能：击球函数，包含一局比赛中几乎所有击球动作。

击球时根据击球模式，使用进攻或非进攻下的命中率判断是否命中，**命中则转至接球方的 `Catch` 函数**，未命中则接球方加分并重新发球。

**选手进攻（非进攻）命中率=基础进攻（非进攻）命中率\*额外倍率1（由 `MoodandRand` 函数生成）**

参数：int phit击球者编号（球由选手phit被击给选手（1-phit））

Int mod击球模式 0为常规非进攻发球,1为第一板发球,2为接抢,3为发抢,4为发球反攻,5为接发球

**（6）`Catch` 接球函数**

功能：接球函数，当击球函数中击球方命中后焦点转到接球方的接球函数。

接球时先判断是否成功接球，**选手进攻（非进攻）接球成功率=基础进攻（非进攻）接球成功率\*额外倍率2（由 `MoodandRand` 函数生成）。**

若接球失败，则击球方得分。

若接球成功，则**根据对应击球模式决定对策**。如击球方是第一板发球，根据接球者的接抢使用率随机使用接抢或接发球。然后接球方作为新的击球方并**再次调用 `Hit` 击球函数**；如击球方接球抢攻，则接球者随机使用发球反攻或非进攻击球；如击球方接发球，则接球者随机使用发球抢攻或非进攻击球。

当接到发球抢攻、发球反攻或决定非进攻击球后，下一回合进入相持。**调用 `Stalemate` 相持函数**，由双方选手的相持能力产生概率，随机该球的得分方。

参数：int pcth接球者编号

Int mod击球者的击球模式 0为常规非进攻发球,1为第一板发球,2为接抢,3为发抢,4为发球反攻,5为接发球
